# Random number generator (RNG) - генератор случайных чисел
## Введение
Процессор RNG - это генератор случайных чисел, основанный на непрерывном аналоговом шуме, который предоставляет 32-битное случайное значение для хоста при чтении.

RNG прошел испытания FIPS PUB 140-2 (10 октября 2001 г.) с коэффициентом успеха 99%.

## Основные характеристики генератора:

• Он предоставляет 32-битные случайные числа, производимые аналоговым генератором

• 40 периодов тактового сигнала RNG_CLK между двумя последовательными случайными числами

• Мониторинг энтропии RNG для выявления ненормального поведения (генерация стабильных значений или устойчивой последовательности значений)

• Может быть отключен, чтобы уменьшить потребление энергии

## Функциональное описание
Блок-схема RNG

![Image alt](https://github.com/nekida/stm32f4-discovery/blob/master/RNG/pic/block_diagram.jpg)

Генератор реализован на аналоговой схеме, генерирующей начальные числа, попадающие в сдвиговый регистр с линейной обратной связью LFSR для получения 32-разрядного случайного числа. 

Аналоговая схема состоит из нескольких кольцевых осцилляторов, выходы которых идут через XOR для генерации начальных чисел. RNG_LFSR тактируется выделенным тактовым сигналом (RNG_CLK) с постоянной частотой, так что качество случайного числа не зависит от частоты HCLK. Содержимое RNG_LFSR передается в регистр данных (RNG_DR), когда в RNG_LFSR введено значительное количество начальных чисел.

Параллельно отслеживаются аналоговое начальное число и выделенные клоки RNG_CLK. Биты состояния (в регистре RNG_SR) указывают, когда на начальном этапе возникает ненормальная последовательность или когда частота тактового сигнала RNG_CLK слишком низкая. Прерывание может быть сгенерировано при обнаружении ошибки.

## Настройка
Чтобы запустить RNG, нужно выполнить следующие действия:

1. Включите прерывание, если необходимо (для этого установите бит IE в регистре RNG_CR). Прерывание генерируется, когда случайное число готово или когда происходит ошибка.

2. Включите генерацию случайных чисел, установив бит RNGEN в регистр RNG_CR. Это активирует аналоговую часть, RNG_LFSR и детектор ошибок.

3. При каждом прерывании убедитесь, что ошибки не возникло (биты SEIS и CEIS должны быть равны «0» в регистре RNG_SR) и что случайное число готово (бит DRDY равен «1» в регистре RNG_SR). Содержимое регистра RNG_DR может быть прочитано.

В соответствии с требованиями FIPS PUB (Федеральный стандарт по обработке информации) 140-2 первое случайное число, сгенерированное после установки бита RNGEN, не должно использоваться, но должно сохраняться для сравнения со следующим сгенерированным случайным числом. Каждое последующее сгенерированное случайное число должно сравниваться с ранее сгенерированным числом. Проверка не выполняется, если любые два сравниваемых числа равны (непрерывный тест генератора случайных чисел).

## Управление ошибками

### Если бит CEIS читается как «1» (ошибка синхронизации)

В этом случае RNG больше не может генерировать случайные числа, потому что клоки RNG_CLK не верны. Убедитесь, что контроллер тактирования правильно сконфигурирован для обеспечения клоками RNG и сброса бита CEIS. RNG может работать, когда бит CECS равен «0». Ошибка синхронизации не влияет на ранее сгенерированные случайные числа, и можно использовать содержимое регистра RNG_DR.

### Если бит SEIS читается как «1» (ошибка заполнения)

В этом случае происходит ошибка начального числа и генерация случайных чисел прерывается до тех пор, пока бит SECS равен «1». Если число доступно в регистре RNG_DR, его нельзя использовать, потому что оно может не обладать достаточной энтропией. Что вы должны сделать, это очистить бит SEIS, затем очистить и установить бит RNGEN для повторной инициализации и перезапустить RNG.

## Регистры RNG

### RNG_CR
Регистр управления (Control register).

#### Используются биты:

##### 3 - бит IE: разрешение прерываний

0: прерывание выключено

1: прерывание включено. Прерывание ожидает, когда DRDY = 1 или SEIS = 1 или CEIS = 1 в регистре RNG_SR.

##### 2 - бит RNGEN: включение генератора случайных чисел

0: генератор выключен

1: генератор включен

### RNG_SR
Региср состояния (Status register)

#### Используются биты:

##### 6 - бит SEIS: прерывание из-за ошибки начального числа
Этот бит устанавливается в то же время, что и SECS, он очищается путем записи 0.

0: неисправная последовательность не обнаружена

1: обнаружена одна из следующих ошибочных последовательностей:

- Более 64 последовательных битов при одном и том же значении (0 или 1)

- Более 32 последовательных чередований 0 и 1 (0101010101 ... 01)

Прерывание ожидает, если IE = 1 в регистре RNG_CR.

##### 5 - бит CEIS: состояние прерывания из-за ошибки синхронизации
Этот бит устанавливается одновременно с CECS, он очищается путем записи 0.

0: клоки RNG_CLK были правильно определены

1: RNG_CLK не был правильно определен (fRNG_CLK < (fHCLK / 16) )

Прерывание ожидает, если IE = 1 в регистре RNG_CR.

##### 2 - бит SECS: текущее состояние ошибки начального числа

0: в данный момент не было обнаружено ошибочной последовательности. Если бит SEIS установлен, это означает, что была обнаружена неправильная последовательность, и ситуация была восстановлена.

1: Обнаружена одна из следующих ошибочных последовательностей:
- Более 64 последовательных битов при одном и том же значении (0 или 1)
- Более 32 последовательных чередований 0 и 1 (0101010101 ... 01)

##### 1 - бит CECS: ошибка клоков текущего состояния

0: клоки RNG_CLK были правильно определены. Если бит CEIS установлен, это означает, что ошибка часов была обнаружена и ситуация была восстановлена

1: RNG_CLK не был правильно обнаружен (fRNG_CLK < (fHCLK / 16)).

##### 0 - бит DRDY: готовность данных

0: регистр RNG_DR еще не действителен, случайные данные недоступны

1: регистр RNG_DR содержит действительные случайные данные

Прерывание ожидает, если IE = 1 в регистре RNG_CR. После считывания регистра RNG_DR этот бит возвращается к 0, пока не будет вычислено новое действительное значение.

### RNG_DR
Регистр данных (Data register)

Регистр RNG_DR является регистром только для чтения, который выдает 32-битное случайное значение при чтении. После считывания этот регистр выдает новое случайное значение после максимального времени в 40 периодов клоков RNG_CLK. Программное обеспечение должно проверить, что бит DRDY установлен перед считыванием значения RNDATA.
